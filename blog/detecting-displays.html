<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <meta name="author" content="2009-06-23">
  <title>Detecting Displays</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #0000ff; } /* Keyword */
code > span.ch { color: #008080; } /* Char */
code > span.st { color: #008080; } /* String */
code > span.co { color: #008000; } /* Comment */
code > span.ot { color: #ff4000; } /* Other */
code > span.al { color: #ff0000; } /* Alert */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #008000; font-weight: bold; } /* Warning */
code > span.cn { } /* Constant */
code > span.sc { color: #008080; } /* SpecialChar */
code > span.vs { color: #008080; } /* VerbatimString */
code > span.ss { color: #008080; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { } /* Variable */
code > span.cf { color: #0000ff; } /* ControlFlow */
code > span.op { } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #ff4000; } /* Preprocessor */
code > span.do { color: #008000; } /* Documentation */
code > span.an { color: #008000; } /* Annotation */
code > span.cv { color: #008000; } /* CommentVar */
code > span.at { } /* Attribute */
code > span.in { color: #008000; } /* Information */
  </style>
  <link rel="stylesheet" href="/writ.min.css">
</head>
<body>
<header>
<h1>fabián cañas</h1>
<nav>
<ul>
  <li><a href='/'>about</a></li>
  <li><a href='/blog/'>writing</a></li>
  <li><a href='/software/'>software</a></li>
  |
  <li><a href='https://www.github.com/fcanas'>GitHub</a></li>
  <li><a href='https://www.twitter.com/fcanas'>Twitter</a></li>
</ul>
</nav>
</header>
<main>
<article>
<h1>Detecting Displays</h1>
<p>In the process of making <a href="/open-source/mirror-displays/">Mirror Displays</a> I learned more or less what Quartz Display Services in Mac OS X has to offer. It more or less lets to get and set all size, position, color, gamma, mirroring settings for attached monitors. It lets you fade the monitors in and out, and lets your app monopolize output to any monitors. An important element to the Display Services though, is that you can register to be notified of any changes to the displays.</p>
<p>I’m writing this particular post because I know that Java has some <a href="http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=4417795">problems</a> when it comes to dynamically detecting multiple monitors when you go and connect and disconnect them. Though I certainly hope Sun eventually fixes the problem, this sounded like the sort of thing that unfortunately needs to be solved on the native platform. I haven’t done any programming in Windows or Linux in a long time, but I hope I can help those using Mac OS X by showing you a barebones program that just sits and listens for display changes. I’m not going to make it talk to Java, but you make a little client-server setup, or maybe you could use the <a href="http://developer.apple.com/documentation/Cocoa/Conceptual/ScriptingBridgeConcepts/Introduction/Introduction.html">Scripting Bridge</a> that’s available with Leopard if you want to get fancy.</p>
<p>First, the design for the app is not particularly important. I chose one of the easier paths, but probably not the sleekest. I made a new Cocoa application, defined a new Cocoa object named Detector, and put an instance of it in the application’s nib file so it one would get initialized as soon as the app started running. All the object does is register a function callback for notifications when it’s loaded, and stop the function from being called when the object is deallocated (the program exits). As I said, this was just what I decided to do to get the thing up and running as fast as possible. It’s only important to mention so the code actually makes sense.</p>
<div class="sourceCode"><pre class="sourceCode objectivec"><code class="sourceCode objectivec"><span class="kw">@implementation</span> Detector

-(<span class="dt">void</span>) awakeFromNib
{
    CGError err = CGDisplayRegisterReconfigurationCallback(ReconfigurationCallBack,<span class="kw">self</span>);
    <span class="kw">if</span> (err != kCGErrorSuccess){
        NSLog(CGErrorToString(err));
        <span class="kw">return</span>;
    }
}

-(<span class="dt">void</span>) dealloc
{
    CGError err = CGDisplayRemoveReconfigurationCallback(ReconfigurationCallBack, <span class="kw">self</span>);
    <span class="kw">if</span> (err != kCGErrorSuccess){
        NSLog(CGErrorToString(err));
        <span class="kw">return</span>;
    }
    [<span class="kw">super</span> dealloc];
}

<span class="kw">@end</span></code></pre></div>
<p>The heavy lifting gets done with the callback function ReconfigurationCallBack.</p>
<div class="sourceCode"><pre class="sourceCode objectivec"><code class="sourceCode objectivec"><span class="dt">void</span> ReconfigurationCallBack (CGDirectDisplayID display, CGDisplayChangeSummaryFlags flags, <span class="dt">void</span> *userInfo){
    CGDisplayCount onlineDisplays;
    CGDisplayCount activeDisplays;
    CGDisplayCount maxDisplays = <span class="dv">3</span>;
    CGDirectDisplayID displayArray[] = {<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>};

    NSString *title, *message;
    BOOL addedOrRemoved = FALSE;

    <span class="kw">if</span> (flags &amp; kCGDisplayAddFlag) {
        title = <span class="st">@&quot;Display Added&quot;</span>;
        addedOrRemoved = TRUE;
    } <span class="kw">else</span> <span class="kw">if</span> (flags &amp; kCGDisplayRemoveFlag) {
        title = <span class="st">@&quot;Display Removed&quot;</span>;
        addedOrRemoved = TRUE;
    }

    <span class="kw">if</span> (addedOrRemoved){

        <span class="co">// Checking for online displays (monitors physically available)</span>
        CGDisplayErr err = CGGetOnlineDisplayList (maxDisplays, displayArray, &amp;onlineDisplays);
        <span class="kw">if</span> (err != kCGErrorSuccess){
            NSLog(CGErrorToString(err));
            <span class="kw">return</span>;
        }
        <span class="co">// Checking for the number of screens available.</span>
        err = CGGetActiveDisplayList(maxDisplays, displayArray, &amp;activeDisplays);
        <span class="kw">if</span> (err != kCGErrorSuccess){
            NSLog(CGErrorToString(err));
            <span class="kw">return</span>;
        }

        message = [NSString stringWithFormat:<span class="st">@&quot;%d physical displays available.</span><span class="sc">\n</span><span class="st">%d screens to draw to.&quot;</span>, onlineDisplays, activeDisplays];

        <span class="kw">if</span> (onlineDisplays&gt;<span class="dv">1</span>)
        message = [NSString stringWithFormat:<span class="st">@&quot;%@</span><span class="sc">\n\n</span><span class="st">Mirroring is turned %@&quot;</span>,message,
         (activeDisplays &lt; onlineDisplays)?<span class="st">@&quot;on&quot;</span>:<span class="st">@&quot;off&quot;</span>];

        id panel = NSGetAlertPanel(title, message, <span class="st">@&quot;Ok&quot;</span>, nil, nil);
        NSModalSession session = [NSApp beginModalSessionForWindow:panel];
        <span class="kw">for</span> (;;) {
            <span class="kw">if</span> ([NSApp runModalSession:session] != NSRunContinuesResponse)
            <span class="kw">break</span>;
        }
        [NSApp endModalSession:session];
        NSReleaseAlertPanel(panel);
    }
}</code></pre></div>
<p>This function uses another function I wrote when working with Display services to decode the <code>CGError</code>s that come up:</p>
<div class="sourceCode"><pre class="sourceCode objectivec"><code class="sourceCode objectivec">NSString* CGErrorToString(CGError err){
    <span class="kw">switch</span> (err) {
        <span class="kw">case</span> kCGErrorSuccess:
            <span class="kw">return</span> <span class="st">@&quot;The requested operation was completed successfully.&quot;</span>;
            <span class="kw">break</span>;
        <span class="kw">case</span> kCGErrorFailure:
            <span class="kw">return</span> <span class="st">@&quot;A general failure occurred.&quot;</span>;
            <span class="kw">break</span>;
        <span class="kw">case</span> kCGErrorIllegalArgument:
            <span class="kw">return</span> <span class="st">@&quot;One or more of the parameters passed to a function are invalid. Check for NULL pointers.&quot;</span>;
            <span class="kw">break</span>;
        <span class="kw">case</span> kCGErrorInvalidConnection:
            <span class="kw">return</span> <span class="st">@&quot;The parameter representing a connection to the window server is invalid.&quot;</span>;
            <span class="kw">break</span>;
        <span class="kw">case</span> kCGErrorInvalidContext:
            <span class="kw">return</span> <span class="st">@&quot;The CPSProcessSerNum or context identifier parameter is not valid.&quot;</span>;
            <span class="kw">break</span>;
        <span class="kw">case</span> kCGErrorCannotComplete:
            <span class="kw">return</span> <span class="st">@&quot;The requested operation is inappropriate for the parameters passed in, or the current system state.&quot;</span>;
            <span class="kw">break</span>;
        <span class="kw">case</span> kCGErrorNameTooLong:
            <span class="kw">return</span> <span class="st">@&quot;A parameter, typically a C string, is too long to be used without truncation.&quot;</span>;
            <span class="kw">break</span>;
        <span class="kw">case</span> kCGErrorNotImplemented:
            <span class="kw">return</span> <span class="st">@&quot;Return value from obsolete function stubs present for binary compatibility, but not normally called.&quot;</span>;
            <span class="kw">break</span>;
        <span class="kw">case</span> kCGErrorRangeCheck:
            <span class="kw">return</span> <span class="st">@&quot;A parameter passed in has a value that is inappropriate, or which does not map to a useful operation or value.&quot;</span>;
            <span class="kw">break</span>;
        <span class="kw">case</span> kCGErrorTypeCheck:
            <span class="kw">return</span> <span class="st">@&quot;A data type or token was encountered that did not match the expected type or token.&quot;</span>;
            <span class="kw">break</span>;
        <span class="kw">case</span> kCGErrorNoCurrentPoint:
            <span class="kw">return</span> <span class="st">@&quot;An operation relative to a known point or coordinate could not be done, as there is no known point.&quot;</span>;
            <span class="kw">break</span>;
        <span class="kw">case</span> kCGErrorInvalidOperation:
            <span class="kw">return</span> <span class="st">@&quot;The requested operation is not valid for the parameters passed in, or the current system state.&quot;</span>;
            <span class="kw">break</span>;
        <span class="kw">case</span> kCGErrorNoneAvailable:
            <span class="kw">return</span> <span class="st">@&quot;The requested operation could not be completed as the indicated resources were not found.&quot;</span>;
            <span class="kw">break</span>;
        <span class="kw">default</span>:
            <span class="kw">return</span> <span class="st">@&quot;An error occurred but its code is unknown by Quartz Display Services as of v10.5.7&quot;</span>;
            <span class="kw">break</span>;
    }
}</code></pre></div>
<p>Whichever files these three code blocks end up in, they each need to have access to the Application Services framework, and so it must be added to the project and the appropriate header must be included</p>
</article>
</main>
</body>
</html>
